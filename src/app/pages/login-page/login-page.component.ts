// ==================== IMPORTS ====================
import { Router, RouterLink } from '@angular/router';
import {
  afterNextRender,
  Component,
  DestroyRef,
  inject,
  signal,
  viewChild,
} from '@angular/core';
import { FormsModule, NgForm } from '@angular/forms';
import { GoogleComponent } from '../../components/google/google.component';
import { debounceTime } from 'rxjs';
import { AuthService } from '../../services/auth.service';
import { TokenService } from '../../services/token.service';
import { type UserLogin } from '../../models/user.model';
import { TranslateModule, TranslateService } from '@ngx-translate/core';

// ==================== COMPONENT DECORATOR ====================
@Component({
  selector: 'app-login',
  standalone: true,
  imports: [FormsModule, GoogleComponent, TranslateModule],
  templateUrl: './login-page.component.html',
  styleUrl: './login-page.component.css',
})
export class LoginComponent {
  // ==================== STATE / PROPERTY ====================
  RememberMe = false;
  ShowPass = false;
  formSubmitted = false;
  isWrong = false;
  isSubmitting = false;
  errorMsg = '';
  showForgotPassword = signal(false);

  // ==================== VIEWCHILD & DEPENDENCY INJECTION ====================
  private form = viewChild.required<NgForm>('form');
  private destroyRef = inject(DestroyRef);
  private authService = inject(AuthService);
  private tokenService = inject(TokenService);
  public router = inject(Router);
  private translate = inject(TranslateService);

  // ==================== CONSTRUCTOR ====================
  constructor() {
    afterNextRender(() => {
      // --- L·∫•y th√¥ng tin login ƒë√£ l∆∞u ---
      let savedForm: string | null = null;
      if (window.localStorage.getItem('Remember-login-form')) {
        savedForm = window.localStorage.getItem('Remember-login-form');
      } else if (window.localStorage.getItem('save-login-form')) {
        savedForm = window.localStorage.getItem('save-login-form');
      }
      if (savedForm) {
        const loadedFormData = JSON.parse(savedForm);
        Promise.resolve().then(() => {
          if (this.form().controls['phone'] && loadedFormData.phone) {
            this.form().controls['phone'].setValue(loadedFormData.phone);
          }
          if (this.form().controls['password'] && loadedFormData.password) {
            this.form().controls['password'].setValue(loadedFormData.password);
          }
          if (this.form().controls['rememberMe'] && loadedFormData.rememberMe) {
            this.form().controls['rememberMe'].setValue(
              loadedFormData.rememberMe
            );
            this.RememberMe = loadedFormData.rememberMe;
          }
        });
      }

      // --- Auto save s·ªë ƒëi·ªán tho·∫°i v√†o localStorage m·ªói l·∫ßn user nh·∫≠p ---
      const subscription = this.form()
        .valueChanges?.pipe(debounceTime(500))
        .subscribe({
          next: (value) =>
            window.localStorage.setItem(
              'save-login-form',
              JSON.stringify({ phone: value.phone })
            ),
        });
      this.destroyRef.onDestroy(() => subscription?.unsubscribe());
    });
  }

  // ==================== METHODS ====================
  openForgotPassword(event: Event) {
    event.preventDefault();
    this.showForgotPassword.set(true);
  }

  closeForgotPassword() {
    this.showForgotPassword.set(false);
  }
  // X·ª≠ l√Ω khi sai th√¨ set l·∫°i error
  onInput() {
    this.isWrong = false;
    this.errorMsg = '';
  }
  /**
   * X·ª≠ l√Ω khi submit form ƒëƒÉng nh·∫≠p
   * @param formData D·ªØ li·ªáu form (NgForm)
   */
  onSubmit(formData: NgForm) {
    if (this.isSubmitting) return;
    this.isSubmitting = true;
    this.formSubmitted = true;
    this.errorMsg = '';

    console.log('üöÄ LOGIN COMPONENT - Form submission started');
    console.log('üìã Form valid:', formData.valid);
    console.log('üìã Form errors:', formData.errors);
    console.log('üìã Full form value:', formData.form.value);

    if (formData.valid) {
      // --- L·∫•y gi√° tr·ªã t·ª´ form ---
      const phone: UserLogin['phone'] = formData.form.value.phone;
      const password: UserLogin['password'] = formData.form.value.password;
      const rememberMe = formData.form.value.rememberMe;

      console.log('üì± Phone from form:', phone);
      console.log('üîí Password from form (length):', password.length);
      console.log(
        'üîí Password from form (first 2 chars):',
        password.substring(0, 2) + '***'
      );
      console.log('üíæ Remember me:', rememberMe);
      console.log('üìä Form data type check:');
      console.log('  - phone type:', typeof phone);
      console.log('  - password type:', typeof password);
      console.log('  - rememberMe type:', typeof rememberMe);

      // --- G·ªçi API login ---
      console.log('üîÑ Calling authService.loginWithPhone...');
      const subscription = this.authService
        .loginWithPhone(phone, password)
        .subscribe({
          next: (res: any) => {
            console.log('‚úÖ LOGIN COMPONENT - Success response received');
            console.log('üì¶ Full response object:', res);
            console.log('üì¶ Response type:', typeof res);
            console.log('üì¶ Response keys:', Object.keys(res || {}));

            // --- L·∫•y token t·ª´ response (t√πy BE) ---
            const token =
              res.access_token ||
              (res.data && res.data.access_token) ||
              res.token;

            console.log('üé´ Token extraction:');
            console.log('  - res.access_token:', res.access_token);
            console.log('  - res.data?.access_token:', res.data?.access_token);
            console.log('  - res.token:', res.token);
            console.log(
              '  - Final token:',
              token ? token.substring(0, 20) + '...' : 'null'
            );

            if (token) {
              console.log('üíæ Token found, processing storage...');

              // Save user data if available in response
              if (res.data?.user || res.user) {
                const userData = res.data?.user || res.user;
                const userDataToSave = {
                  id: userData.id || 'phone-user',
                  phone: userData.phone || phone,
                  email: userData.email || '',
                  name: userData.full_name || userData.name || 'Phone User',
                  authenticated_at: new Date().toISOString(),
                  patient_profile: {
                    id: userData.id || 'phone-user',
                    full_name:
                      userData.full_name || userData.name || 'Phone User',
                    phone: userData.phone || phone,
                    email: userData.email || '',
                    patient_status: 'active',
                    created_at: userData.created_at || new Date().toISOString(),
                    updated_at: userData.updated_at || new Date().toISOString(),
                  },
                };
                localStorage.setItem(
                  'current_user',
                  JSON.stringify(userDataToSave)
                );
                console.log('‚úÖ User data saved to localStorage after login');
              }

              // --- X·ª≠ l√Ω l∆∞u token + remember me ---
              if (rememberMe) {
                console.log('üíæ Saving to localStorage (Remember Me = true)');
                this.tokenService.setToken(token); // L∆∞u v√†o localStorage
                localStorage.setItem(
                  'Remember-login-form',
                  JSON.stringify({
                    phone,
                    password,
                    rememberMe: true,
                  })
                );
                sessionStorage.removeItem('access_token');
              } else {
                console.log(
                  'üíæ Saving to sessionStorage (Remember Me = false)'
                );
                this.tokenService.setTokenSession(token); // L∆∞u v√†o sessionStorage
                localStorage.removeItem('Remember-login-form');
                localStorage.removeItem('save-login-form');
                localStorage.removeItem('access_token');
              }
              console.log('üè† Navigating to home page...');
              // --- Chuy·ªÉn h∆∞·ªõng v·ªÅ trang ch·ªß ---
              this.router.navigate(['/']);
              // formData.resetForm(); // (optional) Reset form sau login
            } else {
              console.log('‚ùå No token found in response!');
            }
          },
          error: (err: any) => {
            console.log('‚ùå LOGIN COMPONENT - Error response received');
            console.log('üì¶ Full error object:', err);
            console.log('üì¶ Error status:', err.status);
            console.log('üì¶ Error statusText:', err.statusText);
            console.log('üì¶ Error message:', err.message);
            console.log('üì¶ Error body:', err.error);
            console.log('üì¶ Error headers:', err.headers);
            console.log('üì¶ Error url:', err.url);

            // --- X·ª≠ l√Ω l·ªói ---
            if (err.status === 401) {
              console.log('üîí 401 Unauthorized - Invalid credentials');
              this.errorMsg = this.translate.instant(
                'LOGIN.ERRORS.INVALID_CREDENTIALS'
              );
              this.isWrong = true;
              alert(this.errorMsg);
            } else if (err.status === 500) {
              console.log('üî• 500 Server Error');
              this.errorMsg = this.translate.instant(
                'LOGIN.ERRORS.SERVER_ERROR'
              );
              alert(this.errorMsg);
            } else {
              console.log('‚ùì Other error status:', err.status);
              this.errorMsg = this.translate.instant(
                'LOGIN.ERRORS.LOGIN_FAILED'
              );
              alert(this.errorMsg);
            }
            this.isSubmitting = false;
          },
          complete: () => {
            console.log('üèÅ LOGIN COMPONENT - Request completed');
            this.isSubmitting = false;
          },
        });
      this.destroyRef.onDestroy(() => subscription?.unsubscribe());
    } else {
      console.log('‚ùå LOGIN COMPONENT - Form is invalid');
      console.log('üìã Form errors:', formData.errors);
      console.log('üìã Form controls status:');
      Object.keys(formData.controls).forEach((key) => {
        const control = formData.controls[key];
        console.log(`  - ${key}:`, {
          value: control.value,
          valid: control.valid,
          errors: control.errors,
          touched: control.touched,
          dirty: control.dirty,
        });
      });
      this.formSubmitted = true;
      this.isSubmitting = false;
      return;
    }
  }
}
